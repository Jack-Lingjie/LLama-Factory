description: bitnet

target:
  service: sing
  name: msroctovc
  resource_group: gcr-singularity-octo
  workspace_name: Workspace_NLC
  # workspace_name: NLC_Workspace


environment:
  image: amlt-sing/acpt-rocm6.1_ubuntu20.04_py3.9_pytorch2.1.2
  setup:
  - echo "master_addr:" "$$MASTER_ADDR"
  - echo "master_port:" $$MASTER_PORT
  - echo "node_rank:" $$OMPI_COMM_WORLD_RANK



code:
  local_dir: $CONFIG_DIR/..

storage:
  lingjiejiang:
    storage_account_name: msranlpintern
    container_name: lingjiejiang
  msranlp:
    storage_account_name: msranlp
    container_name: unilm

code:
  local_dir: $CONFIG_DIR/..

storage:
  lingjiejiang:
    storage_account_name: msranlpintern
    container_name: lingjiejiang
#   msranlp:
#     storage_account_name: msranlp
#     container_name: unilm
#   nlcredstone:
#     storage_account_name: nlcredstone
#     container_name: unilm
#   conversationhub:
#     storage_account_name: conversationhub
#     container_name: unilm
#   conversationhubhot:
#     storage_account_name: conversationhubhot
#     container_name: tengchaolv


search:
  job_template:
    name: PRJ-0349-A54-1_.58_-bit-LLMs-test-scaling
    sku: 1x192G8-MI300X-IB-xGMI
    identity: managed
    # mpi: True
    # process_count_per_node: 8
    command:
    - pip install -e ".[torch,metrics]"
    - pip install deepspeed==0.14.4
    - rocm-smi
    - export PATH=$$PATH:/home/aiscuser/.local/bin
    - sudo chmod -R 777 /opt/conda/bin
    - sudo chmod -R 777 /opt/conda/share
    - sudo apt update ; sudo apt install amd-smi-lib
    #- pip install --user torch==2.4 --index-url https://download.pytorch.org/whl/rocm6.1
    # fix error: NameError: name 'amdsmi' is not defined
    #- pip uninstall pynvml nvidia-ml-py -y
    # cache the wheel file
    - pip install /mnt/msranlp/amd/flash_attn-2.6.3+torch2.1+rocm6.1-cp39-cp39-linux_x86_64.whl
    - echo $${rank}
    - export CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7
    - pip install transformers
    - pip install datasets
    - pip install peft
    - pip install trl --user
    - pip install matplotlib
    - ls /mnt/lingjiejiang
    # - ls /mnt/msranlp
    # - ls /mnt/nlcredstone
    # - ls /mnt/conversationhub
    # - ls /mnt/conversationhubhot
    # - FORCE_TORCHRUN=1 llamafactory-cli train bash_script/{rank}
    # - torchrun --nproc_per_node=8 --nnodes=2 --node_rank=$$OMPI_COMM_WORLD_RANK --master_addr="$$MASTER_ADDR" --master_port=$$MASTER_PORT src/train.py bash_script/{rank}
    - torchrun --nproc_per_node=8 src/train.py bash_script/{rank}
    submit_args:
      env:
        SHARED_MEMORY_PERCENT: 1.0
  type: grid
  max_trials: 500
  params:
    - name: rank
      spec: discrete
      # values: ['ta_chosen_llama3.1_instruct_dpo_2048_default_template_job.yaml', 'ta_chosen_tuluv2_dpo_2048_default_template_job.yaml', 'ta_rejected_llama3.1_instruct_dpo_2048_default_template_job.yaml', 'ta_rejected_tuluv2_dpo_2048_default_template_job.yaml']
      # values: ['ta_rejected_tuluv2_dpo_2048_default_template_job.yaml', 'ta_rejected_tuluv2_dpo_2048_default_template_v2_job.yaml', 'ta_rejected_tuluv2_dpo_2048_default_template_v3_job.yaml']
      # values: ['glanchatv2_full_sft_2048_default_template_job_lr5e6_e3.yaml', 'glanv2_full_sft_2048_default_template_job_lr5e6_e3.yaml', 'glanv2_glanchatv2_full_sft_2048_default_template_job_lr5e6_e3.yaml']
      # values: ['glanv2_glanchatv2_full_sft_2048_default_template_job_lr5e6_e3.yaml']
      # values: ['glanchatv2_full_sft_glan_v2_2048_default_template_job_lr5e6_e3.yaml']
      # values: ['glanchatv2_1_full_sft_2048_default_template_job_lr5e6_e3.yaml']
      # values: ['magpie_full_sft_2048_default_template_job_lr5e6_e3.yaml']
      # values: ['magpie_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job.yaml']
      # values: ['xxmath_reason_full_sft_2048_default_template_job_lr5e6_e3y.yaml']
      # values: ['magpie_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job.yaml']
      # values: ['glan_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job_e2.yaml', 'glan_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job.yaml']
      values: ['magpie_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job_beta.yaml', 'magpie_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job_bsz64.yaml', 'magpie_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job_bsz256.yaml', 'magpie_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job_lr1.yaml', 'magpie_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job_lr2.yaml', 'magpie_dpo_v0.1_8b_2048_default_template_8500_dpo_fullft_job_lr3.yaml']

